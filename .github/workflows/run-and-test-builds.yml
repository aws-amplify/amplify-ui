name: Run and Test Builds

on:
  pull_request:
    branches: [main, actions]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Paths for each example app we want to test build on
        path:
          - angular/angularcli
          - react/cra
          - react/cra-ts
          - react/next
          - react/vite
          - vue/vite
          - vue/vuecli
    steps:
      - name: Checkout Amplify UI
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Setup Node.js LTS
        uses: actions/setup-node@v2
        with:
          node-version: lts/*
          cache: 'yarn'
      - name: Ignore monorepo postcss.config.js
        run: mv postcss.config.js _postcss.config.js
      - name: Install packages
        run: yarn install --no-lockfile
        working-directory: ./canary/apps/${{ matrix.path }}
      - name: Build example app
        run: yarn build
        working-directory: ./canary/apps/${{ matrix.path }}
     - name: Pull down AWS environments
        run: yarn pull
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        working-directory: ./canary
    - name: Install cypress 
        run: yarn install
        working-directory: ./canary/e2e
     - name: Start ${{ matrix.example }} example
        run: yarn start & npx wait-on -c waitOnConfig.json -t 20000 http-get://localhost:3000
        working-directory: ./canary/apps/${{ matrix.path }}
     - name: Run E2E tests against ${{ matrix.example }} example
        run: yarn test
        env:
          # Env values for testing flows
          DOMAIN: ${{ secrets.DOMAIN }}
          PHONE_NUMBER: ${{ secrets.PHONE_NUMBER }}
          USERNAME: ${{ secrets.USERNAME }}
          NEW_PASSWORD: ${{ secrets.NEW_PASSWORD }}
          VALID_PASSWORD: ${{ secrets.VALID_PASSWORD }}
