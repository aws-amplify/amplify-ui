<template>
  <div>
    <sign-in
      v-if="actorState?.matches('signIn')"
      @sign-in-submit="onSignInSubmitI"
      ref="signInComponent"
    >
      <template #signInSlotI>
        <slot name="sign-in"></slot>
      </template>

      <template #forgot-password-section="{ onForgotPasswordClicked }">
        <slot
          name="sign-in-forgot-password-section"
          :onForgotPasswordClicked="onForgotPasswordClicked"
        />
      </template>

      <template #sign-in-button="{ onSignInSubmit }">
        <slot name="sign-in-button" :onSignInSubmit="onSignInSubmit" />
      </template>

      <template
        #form="{
          info,
          onSignInSubmit,
          onCreateAccountClicked,
          onForgotPasswordClicked,
        }"
      >
        <slot
          name="sign-in-form"
          :info="info"
          :onSignInSubmit="onSignInSubmit"
          :onCreateAccountClicked="onCreateAccountClicked"
          :onForgotPasswordClicked="onForgotPasswordClicked"
        ></slot>
      </template>

      <template #heading>
        <slot name="sign-in-heading"></slot>
      </template>

      <template #footer="{ info, onSignInSubmit, onCreateAccountClicked }">
        <slot
          name="sign-in-footer"
          :info="info"
          :onSignInSubmit="onSignInSubmit"
          :onCreateAccountClicked="onCreateAccountClicked"
        >
        </slot>
      </template>

      <template #additional-fields="{ onSignInSubmit, onCreateAccountClicked }">
        <slot
          name="sign-in-additional-fields"
          :onSignInSubmit="onSignInSubmit"
          :onCreateAccountClicked="onCreateAccountClicked"
        >
        </slot>
      </template>
      <template #signin-fields="{ info }">
        <slot name="sign-in-fields" :info="info"></slot>
      </template>
    </sign-in>
    <sign-up
      v-if="actorState?.matches('signUp')"
      @sign-up-submit="onSignUpSubmitI"
      ref="signUpComponent"
    >
      <template #signup-fields="{ info }">
        <slot name="sign-up-fields" :info="info"></slot>
      </template>

      <template #signUpSlotI>
        <slot name="sign-up"></slot>
      </template>

      <template #footer-left="{ onHaveAccountClicked }">
        <slot
          name="sign-up-footer-left"
          :onHaveAccountClicked="onHaveAccountClicked"
        ></slot>
      </template>

      <template #footer-right="{ onSignUpSubmit }">
        <slot
          name="sign-up-footer-right"
          :onSignUpSubmit="onSignUpSubmit"
        ></slot>
      </template>

      <template #footer="{ info, onHaveAccountClicked, onSignUpSubmit }">
        <slot
          name="sign-up-footer"
          :info="info"
          :onHaveAccountClicked="onHaveAccountClicked"
          :onSignUpSubmit="onSignUpSubmit"
        >
        </slot>
      </template>
    </sign-up>
    <div v-if="actorState?.matches('signIn.rejected')">
      Error! Can't sign in!
    </div>
    <confirm-sign-up
      v-if="actorState?.matches('confirmSignUp')"
      @confirm-sign-up-submit="onConfirmSignUpSubmitI"
      :shouldHideReturnBtn="shouldHideReturnBtn"
      ref="confirmSignUpComponent"
    >
      <template #confirmSignUpSlotI>
        <slot name="confirm-sign-up"></slot>
      </template>
      <template
        #footer="{ info, onConfirmSignUpSubmit, onBackToSignInClicked }"
      >
        <slot
          name="sign-in-footer"
          :info="info"
          :onConfirmSignUpSubmit="onConfirmSignUpSubmit"
          :onBackToSignInClicked="onBackToSignInClicked"
        >
        </slot>
      </template>
    </confirm-sign-up>

    <confirm-sign-in
      v-if="actorState?.matches('confirmSignIn')"
      @confirm-sign-in-submit="onConfirmSignInSubmitI"
      ref="confirmSignInComponent"
    >
      <template #confirmSignInSlotI>
        <slot name="confirm-sign-in"></slot>
      </template>
      <template
        #footer="{ info, onConfirmSignInSubmit, onBackToSignInClicked }"
      >
        <slot
          name="sign-in-footer"
          :info="info"
          :onConfirmSignInSubmit="onConfirmSignInSubmit"
          :onBackToSignInClicked="onBackToSignInClicked"
        >
        </slot>
      </template>
    </confirm-sign-in>

    <setup-totp
      v-if="actorState?.matches('setupTOTP')"
      @confirm-setup-totp-submit="onConfirmSetupTOTPSubmitI"
      ref="confirmSetupTOTPComponent"
    >
      <template #confirmSetupTOTPI>
        <slot name="confirm-setup-totp"></slot>
      </template>
      <template #footer="{ info, onSetupTOTPSubmit, onBackToSignInClicked }">
        <slot
          name="sign-in-footer"
          :info="info"
          :onSetupTOTPSubmit="onSetupTOTPSubmit"
          :onBackToSignInClicked="onBackToSignInClicked"
        >
        </slot>
      </template>
    </setup-totp>

    <force-new-password
      v-if="actorState?.matches('forceNewPassword')"
      @force-new-password-submit="onForceNewPasswordSubmitI"
      ref="forceNewPasswordComponent"
    >
      <template #forceNewPasswordI>
        <slot name="force-new-password"></slot>
      </template>
      <template
        #footer="{ info, onHaveAccountClicked, onForceNewPasswordSubmit }"
      >
        <slot
          name="sign-in-footer"
          :info="info"
          :onForceNewPasswordSubmit="onForceNewPasswordSubmit"
          :onBackToSignInClicked="onHaveAccountClicked"
        >
        </slot>
      </template>
    </force-new-password>
  </div>

  <slot
    v-if="state?.matches('authenticated')"
    :user="state?.context?.user"
  ></slot>
</template>

<script lang="ts">
import { ref, provide, defineComponent, computed } from 'vue';
import { getActorState } from '@aws-amplify/ui-core';

import SignIn from './sign-in.vue';
import SignUp from './sign-up.vue';
import ConfirmSignUp from './confirm-sign-up.vue';
import ConfirmSignIn from './confirm-sign-in.vue';
import SetupTotp from './setup-totp.vue';
import ForceNewPassword from './force-new-password.vue';

import { useAuth } from '../composables/useAuth';
import {
  AuthenticatorSetupReturnTypes,
  SetupEventContext,
} from '../types/index';

export default defineComponent({
  inheritAttrs: false,
  components: {
    SignIn,
    SignUp,
    ConfirmSignUp,
    ConfirmSignIn,
    SetupTotp,
    ForceNewPassword,
  },
  props: {
    shouldHideReturnBtn: {
      default: true,
      type: Boolean,
    },
  },

  setup(
    _,
    { attrs, emit }: SetupEventContext
  ): AuthenticatorSetupReturnTypes & {
    signInComponent: typeof SignIn;
    signUpComponent: typeof SignUp;
    confirmSignUpComponent: typeof ConfirmSignUp;
    confirmSignInComponent: typeof ConfirmSignIn;
    confirmSetupTOTPComponent: typeof SetupTotp;
    forceNewPasswordComponent: typeof ForceNewPassword;
  } {
    const { state, send } = useAuth();
    const actorState = computed(() => getActorState(state.value));
    const signInComponent = ref(null);
    const signUpComponent = ref(null);
    const confirmSignUpComponent = ref(null);
    const confirmSignInComponent = ref(null);
    const confirmSetupTOTPComponent = ref(null);
    const forceNewPasswordComponent = ref(null);

    const currentPage = ref('SIGNIN');

    //methods

    const onSignInSubmitI = (e: Event) => {
      if (attrs?.onSignInSubmit) {
        emit('signInSubmit', e);
      } else {
        signInComponent.value.submit(e);
      }
    };

    const onConfirmSignUpSubmitI = (e: Event) => {
      if (attrs?.onConfirmSignUpSubmit) {
        emit('confirmSignUpSubmit', e);
      } else {
        confirmSignUpComponent.value.submit(e);
      }
    };

    const onConfirmSignInSubmitI = (e: Event) => {
      if (attrs?.onConfirmSignInSubmit) {
        emit('confirmSignInSubmit', e);
      } else {
        confirmSignInComponent.value.submit(e);
      }
    };

    const onConfirmSetupTOTPSubmitI = (e: Event) => {
      if (attrs?.onForceNewPasswordSubmit) {
        emit('mSetupTOTPSubmit', e);
      } else {
        confirmSetupTOTPComponent.value.submit(e);
      }
    };

    const onForceNewPasswordSubmitI = (e: Event) => {
      if (attrs?.onForceNewPasswordSubmit) {
        emit('forceNewPasswordSubmit', e);
      } else {
        forceNewPasswordComponent.value.submit(e);
      }
    };

    const onSignUpSubmitI = (e: Event) => {
      if (attrs?.onSignUpSubmit) {
        emit('signUpSubmit', e);
      } else {
        signUpComponent.value.submit(e);
      }
    };
    provide('pageInfo', currentPage);

    return {
      currentPage,
      state,
      actorState,
      onSignInSubmitI,
      signInComponent,
      signUpComponent,
      forceNewPasswordComponent,
      onSignUpSubmitI,
      confirmSignUpComponent,
      confirmSignInComponent,
      confirmSetupTOTPComponent,
      onConfirmSignInSubmitI,
      onConfirmSignUpSubmitI,
      onConfirmSetupTOTPSubmitI,
      onForceNewPasswordSubmitI,
      send,
    };
  },
});
</script>
