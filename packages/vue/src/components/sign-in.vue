<template>
  <slot name="signInSlotI">
    <base-wrapper data-amplify-wrapper>
      <base-form
        data-amplify-authenticator-signin
        @submit.prevent="onSignInSubmit"
        @input="onInput"
        method="post"
      >
        <template #formt="{ slotData }">
          <slot
            name="form"
            :info="slotData"
            :onSignInSubmit="onSignInSubmit"
            :onCreateAccountClicked="onCreateAccountClicked"
            :onForgotPasswordClicked="onForgotPasswordClicked"
          >
          </slot>
        </template>
        <base-heading :level="1">
          <template #headingI>
            <slot name="heading"></slot>
          </template>
          {{ signIntoAccountText }}
        </base-heading>
        <federated-sign-in></federated-sign-in>
        <base-field-Set :disabled="actorState.matches('signIn.submit')">
          <template #fieldSetI="{ slotData }">
            <slot name="signin-fields" :info="slotData"> </slot>
          </template>
          <user-name-alias data-amplify-usernamealias :userNameAlias="true" />

          <base-label data-amplify-password>
            <sign-in-password-control />

            <base-box>
              <slot
                name="forgot-password-section"
                :onForgotPasswordClicked="onForgotPasswordClicked"
              >
                <base-text> {{ forgotYourPasswordText }}</base-text>
                <base-button
                  type="button"
                  @click.prevent="onForgotPasswordClicked"
                >
                  {{ resetPasswordLink }}
                </base-button>
              </slot>
            </base-box>
          </base-label>
          <slot
            name="additional-fields"
            :onSignInSubmit="onSignInSubmit"
            :onCreateAccountClicked="onCreateAccountClicked"
          ></slot>
        </base-field-Set>
        <base-footer>
          <template #footert="{ slotData }">
            <slot
              name="footer"
              :info="slotData"
              :onSignInSubmit="onSignInSubmit"
              :onCreateAccountClicked="onCreateAccountClicked"
            >
            </slot>
          </template>
          <base-text>{{ noAccount }}</base-text>
          <base-button type="button" @click.prevent="onCreateAccountClicked">{{
            createAccountLink
          }}</base-button>
          <base-spacer />
          <base-button :disabled="actorState.matches('signIn.submit')">
            <template #buttont>
              <slot
                name="sign-in-button"
                :onSignInSubmit="onSignInSubmit"
              ></slot>
            </template>
            {{
              actorState.matches('signIn.submit')
                ? signIngButtonText
                : signInButtonText
            }}
            <!-- Add prop too? -->
          </base-button>
        </base-footer>
        <base-box data-ui-error>
          {{ actorState.context.remoteError }}
        </base-box>
      </base-form>
    </base-wrapper>
  </slot>
</template>

<script lang="ts">
import { Ref, ref, computed, ComputedRef } from 'vue';

import BaseLabel from './primitives/base-label.vue';
import BaseFooter from './primitives/base-footer.vue';
import BaseWrapper from './primitives/base-wrapper.vue';
import BaseForm from './primitives/base-form.vue';
import BaseHeading from './primitives/base-heading.vue';
import BaseFieldSet from './primitives/base-field-set.vue';
import BaseBox from './primitives/base-box.vue';
import BaseButton from './primitives/base-button.vue';
import BaseSpacer from './primitives/base-spacer.vue';
import BaseText from './primitives/base-text.vue';
import SignInPasswordControl from './sign-in-password-control.vue';
import UserNameAlias from './user-name-alias.vue';
import FederatedSignIn from './federated-sign-in.vue';

import {
  SIGN_IN_TEXT,
  AUTHENTICATOR,
  RESET_PASSWORD_LINK,
  NO_ACCOUNT,
  CREATE_ACCOUNT_LINK,
  SIGN_IN_BUTTON_TEXT,
  FORGOT_YOUR_PASSWORD_TEXT,
  PASSWORD_LABEL,
  SIGNING_IN_BUTTON_TEXT,
} from '../defaults/DefaultTexts';

// @xstate
import { useAuth } from '../composables/useAuth';

// types
import { SetupEventContext, SignInSetupReturnTypes } from '../types/index';
import { getActorState, SignInState } from '@aws-amplify/ui-core';

export default {
  name: 'Authentication',
  computed: {
    signIntoAccountText: (): string => SIGN_IN_TEXT,
    resetPasswordLink: (): string => RESET_PASSWORD_LINK,
    noAccount: (): string => NO_ACCOUNT,
    createAccountLink: (): string => CREATE_ACCOUNT_LINK,
    signInButtonText: (): string => SIGN_IN_BUTTON_TEXT,
    signIngButtonText: (): string => SIGNING_IN_BUTTON_TEXT,
    forgotYourPasswordText: (): string => FORGOT_YOUR_PASSWORD_TEXT,
    passwordLabel: (): string => PASSWORD_LABEL,
  },
  inheritAttrs: false,
  components: {
    BaseFooter,
    BaseWrapper,
    BaseForm,
    BaseHeading,
    BaseFieldSet,
    BaseLabel,
    BaseText,
    BaseBox,
    BaseButton,
    BaseSpacer,
    UserNameAlias,
    SignInPasswordControl,
    FederatedSignIn,
  },

  setup(_, { emit, attrs }: SetupEventContext): SignInSetupReturnTypes {
    const { state, send } = useAuth();
    const actorState: ComputedRef<SignInState> = computed(() =>
      getActorState(state.value)
    );

    const username: Ref = ref('');
    const password: Ref = ref('');

    // Methods

    const onInput = (e: Event): void => {
      const { name, value } = <HTMLInputElement>e.target;
      send({
        type: 'CHANGE',
        //@ts-ignore
        data: { name, value },
      });
    };

    const onSignInSubmit = (e: Event): void => {
      if (attrs?.onSignInSubmit) {
        emit('signInSubmit', e);
      } else {
        submit(e);
      }
    };

    const submit = (e: Event): void => {
      const formData = new FormData(<HTMLFormElement>e.target);
      send({
        type: 'SUBMIT',
        // @ts-ignore Property 'fromEntries' does not exist on type 'ObjectConstructor'. Do you need to change your target library? Try changing the `lib` compiler option to 'es2019' or later.ts(2550)
        data: Object.fromEntries(formData),
      });
    };

    const onForgotPasswordClicked = (): void => {
      if (attrs?.onForgotPasswordClicked) {
        emit('forgotPasswordClicked');
      } else {
        // Future
        console.log('you clicked the reset password link');
      }
    };

    const onCreateAccountClicked = (): void => {
      if (attrs?.onCreateAccountClicked) {
        emit('createAccountClicked');
      } else {
        send({
          type: 'SIGN_UP',
        });
      }
    };

    return {
      onSignInSubmit,
      AUTHENTICATOR,
      onForgotPasswordClicked,
      onCreateAccountClicked,
      onInput,
      actorState,
      username,
      password,
      submit,
    };
  },
};
</script>
